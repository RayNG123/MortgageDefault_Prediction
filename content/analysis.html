---
title: "Analysis"
description: null
toc: yes
featuredVideo: null
featuredImage: /images/3.png
draft: no
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>

<div id="TOC">

</div>

<p><span class="math display">\[\\[0.2in]\]</span></p>
<div id="exploratory-analysis-and-modeling" class="section level1">
<h1>Exploratory Analysis and Modeling</h1>
<p><span class="math display">\[\\[0.2in]\]</span>
Motivated by our big picture page, we are shocked by how destructive unregulated mortgage issuance can be to the US economy or even the world. In 2010, the US government promulgated the Dodd Frank Act, which aims to strengthen the risk control and supervision on the entire financial market. Among the act, the monitoring of the mortgage market is the top priority. How to ensure that loan funds flow into the pockets of those who can repay is now a flag for the mortgage industry. The introduction of credit risk control in the mortgage market is not only in line with the new policy, but also has a very promising future. Therefore, we would like to combine what we learnt from data science to measure the credit risk of mortgage default.
<span class="math display">\[\\[0.2in]\]</span></p>
<p>Meanwhile, we found that the subprime mortgage crisis did not happen overnight. Before the crisis, there have been many signs that the housing loan market has been overheating, such as the oversupply in housing market, a short-term increase in housing loan interest rates, a decline in average credit scores, and a bubble in the real estate industry. We are sure that these market phenomena and indexes have a strong relationship with the mortgage default rate. Some are positively correlated, such as mortgage interest rates. Some are negatively correlated, such as individual credit scores. Motivated by these patterns, we would like to uncover the relationship between default probability and different variables including macroeconomic and personal data of specific loans in our EDA. After that, we will conduct a feature selection to filter out useful variables and fit them into different models.
<span class="math display">\[\\[0.2in]\]</span></p>
<p>With that said, there are certain conflicts and limitations in our research. We believe that more variable about personal information can definitely help us determine default probability of specific mortgages. However, we are also worried that acquiring too much personal data may infringe privacy of others. We hope that our model can be accurate without abusing personal information, and we believe that this is one of the most critical ethics problem for most data scientists. Therefore, we hope that we can achieve a balance between accuracy and privacy.
<span class="math display">\[\\[0.2in]\]</span></p>
<p>As we discussed before, the collapse of financial derivative of mortgage like back securities is also a trigger for mortgage default in 2008. From our perspective, stock index can be a good indicator to measure the risk of these financial products. Therefore, to better measure the influence of financial market to mortgage default rate, we combined our S&amp;P stock market index with our major data set to create a new variable: Mean S&amp;P Stock Market Index. Below is the variables that we are interested, and we would like to determine their relationships with default or not one by one.
<span class="math display">\[\\[0.2in]\]</span></p>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Column Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">orig_time</td>
<td align="left">Time stamp for origination of the mortgage</td>
</tr>
<tr class="even">
<td align="left">REtype_SF_orig_time</td>
<td align="left">Single family home</td>
</tr>
<tr class="odd">
<td align="left">investor_orig_time</td>
<td align="left">With investor</td>
</tr>
<tr class="even">
<td align="left">balance_orig_time</td>
<td align="left">Outstanding balance at origination time</td>
</tr>
<tr class="odd">
<td align="left">FICO_orig_time</td>
<td align="left">FICO credit score</td>
</tr>
<tr class="even">
<td align="left">LTV_orig_time</td>
<td align="left">Initial loan to value ratio</td>
</tr>
<tr class="odd">
<td align="left">state_orig_time</td>
<td align="left">US state in which the property is located</td>
</tr>
<tr class="even">
<td align="left">hpi_orig_time</td>
<td align="left">House price index at the origination of the mortgage, base year=100</td>
</tr>
<tr class="odd">
<td align="left">age</td>
<td align="left">number of periods from origination of the mortgage to its end</td>
</tr>
<tr class="even">
<td align="left">interest_rate_mean</td>
<td align="left">the average interest rate of all observation periods</td>
</tr>
<tr class="odd">
<td align="left">gdp_mean</td>
<td align="left">the average GDP growth of all observation periods</td>
</tr>
<tr class="even">
<td align="left">uer_mean</td>
<td align="left">the average unemployment rate of all observation periods</td>
</tr>
<tr class="odd">
<td align="left">default_time</td>
<td align="left">Default Status</td>
</tr>
<tr class="even">
<td align="left">SP</td>
<td align="left">Mean S&amp;P Stock Index during all observation period</td>
</tr>
</tbody>
</table>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>To confirm our directions, we would like to first make a correlation map between default and different explanatory variables:
<span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code># Code from: http://www.sthda.com/english/wiki/ggplot2-quick-correlation-matrix-heatmap-r-software-and-data-visualization
mydata &lt;- mortgage_norm %&gt;% select(default_time,orig_time, REtype_SF_orig_time,investor_orig_time, balance_orig_time,FICO_orig_time, LTV_orig_time, interest_rate_mean, hpi_orig_time,TTM,uer_mean,gdp_mean,age,SP)
names(mydata) = c(&#39;Default or Not&#39;,&#39;Original Time&#39;, &#39;Single Family&#39;, &#39;With Investor&#39;, &#39;Original Balance&#39;,&#39;FICO Credit Score&#39;,&#39;Loan to Value&#39;,&#39;Interest Rate&#39;, &#39;House Price Index&#39;, &#39;Time to Maturity&#39;,&#39;Unemployment Rate&#39;,&#39;GDP Growth&#39;,&#39;Age&#39;,&#39;S&amp;P Stock Index&#39;)
cormat &lt;- round(cor(mydata),2)
get_upper_tri &lt;- function(cormat){
    cormat[lower.tri(cormat)]&lt;- NA
    return(cormat)
  }
upper_tri &lt;- get_upper_tri(cormat)
melted_cormat &lt;- melt(upper_tri, na.rm = TRUE)
reorder_cormat &lt;- function(cormat){
dd &lt;- as.dist((1-cormat)/2)
hc &lt;- hclust(dd)
cormat &lt;-cormat[hc$order, hc$order]
}

cormat &lt;- reorder_cormat(cormat)
upper_tri &lt;- get_upper_tri(cormat)
melted_cormat &lt;- melt(upper_tri, na.rm = TRUE)
ggheatmap &lt;- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = &quot;white&quot;)+
 scale_fill_gradient2(low = &quot;steelblue4&quot;, high = &quot;skyblue&quot;, mid = &quot;white&quot;, 
   midpoint = 0, limit = c(-1,1), space = &quot;Lab&quot;, 
    name=&quot;Pearson\nCorrelation Map&quot;) +
  theme_minimal()+ theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 9, hjust = 1)) + coord_fixed()
ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = &quot;black&quot;, size = 2.3) +
theme(
  axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  legend.justification = c(1, 0),
  legend.position = c(0.6, 0.7),
  legend.direction = &quot;horizontal&quot;) +
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = &quot;top&quot;, title.hjust = 0.1))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-4-1.png" width="672" />
<span class="math display">\[\\[0.2in]\]</span></p>
<p>The Pearson Correlation map above shows the correlations among all variables we have in the time frame of 2000 and 2014. In this map, blue indicates positive relationships and grey indicates negative relationships. We find out that GDP growth has the strongest negative correlations with default or not, which is -0.45. That means that as GDP growth goes higher, the probability of default goes lower. The situation is similar for interest rate and GDP growth with a negative correlation of -0.15. What is more, FICO score which indicates one’s credit is also proven to be important with a correlation of -0.11. As we expected, unemployment rate are the only economic data positively correlated to default probability.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>We also found out that there are a few strong negative correlations between several different variables, which includes Interest Rate vs. FICO Credit Score, Default or not vs. GDP growth, original time vs. GDP growth, House price index vs. GDP growth, Age vs. Original time, and Age vs. House price index. Therefore, we believe that a feature selection process will be important to eliminate pairwise influence and omitted variable bias. Outside economy and inside personal information will both be our focus, and we also hope to measure the difference of their influence to mortgage default probability. As followed, we will start to uncover the relationship between these variables and default probability:
<span class="math display">\[\\[0.2in]\]</span></p>
<div id="default-probability-vs.-gdp-growth" class="section level2">
<h2>Default Probability vs. GDP Growth:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% filter(status_last!= 0) %&gt;% mutate(status = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;)) %&gt;%ggplot(aes(x=gdp_mean, fill= status))+ geom_density(alpha=.5,colour = &#39;white&#39;)+  geom_vline( xintercept= 2.305184, linetype=&quot;dashed&quot;, size=.7, colour = &#39;steelblue1&#39;) + theme_bw()+geom_vline( xintercept= 1.172898 , linetype=&quot;dashed&quot;, size=.7, colour = &#39;steelblue4&#39;) + scale_fill_manual(name = &#39;Distribution&#39;,values=c(&quot;steelblue4&quot;, &quot;steelblue1&quot;)) + labs(x = &quot;GDP Growth&quot;, y = &#39;Density&#39;, title = &#39;Mortgages Distribution Map According to GDP Growth&#39;,subtitle = &#39;Dashed Line: Mean GDP Growth&#39;) + theme(plot.title = element_text(face=&quot;bold&quot;,size = 15))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>The map of mortgages distribution shows us the relationship between the density of mortgages in both default and payoff and GDP growth between 2000 and 2014. As we can see that, both status are mainly in normal distribution. The grey map represents distribution of default mortgages in different GDP growth and the blue map measures those payoffs. The dash lines show us that the mean GDP growth of mortgages in default is smaller than the one with mortgages in payoff. We can see that the shape of distribution are very similar for both Defaults and Payoffs. However, if we take GDP growth into account, it is evident that most default mortgages mainly resides in where GDP growth is lower, which is totally on the left of those payoffs. In that case, we are confident that as GDP growth goes higher, default probability are more likely to be lower, and Vice Versa.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="default-probability-vs.-origination-time" class="section level2">
<h2>Default Probability vs. Origination Time:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>a &lt;- mortgage_norm %&gt;% separate(first_time_date, into = c(&#39;year&#39;,&#39;month&#39;,&#39;date&#39;),sep =&#39;-&#39;) %&gt;% group_by(year,default_time) %&gt;% summarise(n = n()) %&gt;% pivot_wider(names_from = &#39;default_time&#39;,values_from = &#39;n&#39;) </code></pre>
<pre><code>## `summarise()` has grouped output by &#39;year&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code>a[is.na(a)] &lt;- 0
names(a) = c(&#39;Time&#39;,&#39;Payoffs&#39;,&#39;Defaults&#39;)
a %&gt;% mutate(Total = Defaults + Payoffs, Default_Portion = Defaults/Total) %&gt;% ggplot() + geom_line(aes(x = Time, y = Default_Portion),color = &#39;steelblue3&#39;,group = 1)  + geom_point(aes(x = Time, y = Default_Portion,size = Total),color = &#39;steelblue3&#39;)+ theme_bw() + scale_size_continuous(breaks = c(1500,3000,6000,12000)) + labs(x = &quot;Start Time&quot;, y = &#39;Default Portion&#39;, title = &#39;Default Mortgages Portions According to Their Start Time&#39;, size = &#39; Total Mortgages&#39;) +  theme(plot.title = element_text(face=&quot;bold&quot;,size = 14))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>The plot shows us default mortgages portions according to their start time from 2000 to 2014 and the number of mortgages each year. According to the graph, during 2004 to 2007, the number of total mortgages were much larger compared to the rest of years, which were roughly 6000 to 12000, and the default portions increased dramatically in these years from about 0.2 to 0.7. However, right after 2007, we see a big drop in the number of mortgages and mortgages in default. And after a rise during 2009 and 2011, the number of mortgages stays relatively the same and small, but the portion of mortgages in default decreases in remarkably and even down to 0 in 2014. We believe that the difference is because of economic crisis and government regulations right after that. The release of the Dodd Frank act strongly regulates mortgage market. Therefore, the number of mortgage and default rate decreases dramatically after 2010, which fits perfectly to the release time of the act. However, the influence of origination time to default probability can be somewhat represented the GDP growth. Therefore, this variable might be useless to measure default.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="default-probability-vs.-singlefamily" class="section level2">
<h2>Default Probability vs. SingleFamily:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% count(default_time, REtype_SF_orig_time) %&gt;% mutate(SF = ifelse(REtype_SF_orig_time == 1, &#39;SingleFamily&#39;,&#39;Non_SingleFamily&#39;)) %&gt;% mutate(Default = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;))%&gt;% ggplot(aes(x= factor(SF), y = n, fill= factor(Default))) + geom_bar(position = &#39;dodge&#39;, stat=&#39;identity&#39;) + geom_text(aes(label= n), color = &#39;white&#39;,size = 4, position = position_dodge(width=0.9), vjust=5, fontface = &#39;bold&#39;)+ theme_bw() + labs(x = &#39;&#39;, y = &#39;Total Number&#39;, title = &#39;Compare Default or Not and Single Family Status&#39;,fill = &#39;Mortgage Status&#39;)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 15))+ scale_fill_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>The bar chart here shows the number of mortgages in default and payoff comparing non-single family and single family in the time frame of 2000 and 2014. By directly comparing the two bar graphs, it seems that single family tends to have a higher number of defaults. However, we can see that a larger portion of mortgages in our dataset are single family. Therefore, to compare the default/payoff ratio between each graph is more meaningful for us. However, there is no much difference just by first glance.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="default-probability-vs.-investor-status" class="section level2">
<h2>Default Probability vs. Investor Status:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% count(default_time, investor_orig_time) %&gt;% mutate(SF = ifelse(investor_orig_time == 1, &#39;With Investor&#39;,&#39;Without Investor&#39;)) %&gt;% mutate(Default = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;))%&gt;% ggplot(aes(x= factor(SF), y = n, fill= factor(Default))) + geom_bar(position = &#39;dodge&#39;, stat=&#39;identity&#39;) + geom_text(aes(label= n), color = &#39;white&#39;,size = 3.5, position = position_dodge(width=0.9), vjust=1.6,fontface = &#39;bold&#39;)+ theme_bw() + labs(x = &#39;&#39;, y = &#39;Total Number&#39;, title = &#39;Compare Default or Not and Investor Status&#39;,fill = &#39;Mortgage Status&#39;)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 15))+ scale_fill_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>This bar graph shows the number of mortgages separated by default status and with investor or not. According to the graph, it shows an obvious difference between the number of mortgages with investor and without investor. The number of mortgages without investor is significantly higher than the number of mortgages with investor. Moreover, it is shown in the graph that mortgages with investors tends to have a much higher ratio of default. This totally contradicts our assumption, because we think that individual investors will be more informed to determine the default probability of specific mortgages. However, the answer turns out to be not, therefore, we now tend to believe that most investors hoping for higher return tends to select mortgage with higher interest rate, which is subject to higher risk of defaults. So we make another plot to determine the difference of interest rate with and without investors.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% group_by(investor_orig_time) %&gt;% summarise(a = mean(interest_rate_mean)) %&gt;% mutate(SF = ifelse(investor_orig_time == 1, &#39;With Investor&#39;,&#39;Without Investor&#39;)) %&gt;% ggplot(aes(x = SF, y = a, fill = SF)) + geom_col() + coord_cartesian(ylim = c(7, 8))+theme_bw()+theme(plot.title = element_text(face=&quot;bold&quot;,size = 15))+ labs(y = &#39;Interest Rate&#39;,title = &#39;Compare Interest Rate and Investor Status&#39;, fill = &#39;Single Family Status&#39;)+scale_fill_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As we can see from the chart that mortgage with investors tends to have a much higher interest rate for a higher return. In that case, they might experience a greater risk of mortgage default.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="default-probability-vs.-mortgage-size" class="section level2">
<h2>Default Probability vs. Mortgage Size:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% mutate(Default = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;)) %&gt;% filter(balance_orig_time &lt;= 650000) %&gt;% ggplot() + geom_boxplot(aes(x = factor(Default), y = balance_orig_time, fill = factor(Default)),size = 0.5, color = &#39;grey40&#39;) + theme_bw()+ scale_fill_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;)) + labs(y = &#39;Mortgage Size&#39;, x = &#39;&#39;, title = &#39;Compare Default Status and Mortgage Size&#39;, fill = &#39;Mortgage Status&#39;)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 15))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>This boxplot shows the relationship between the mortgage size and the mortgage status. Since there are a few outsiders with extremely large size, we filter out mortgages that are larger than 650000 dollars to avoid distortion of the view. It is shown in the graph that the medium of the mortgage size in default status and payoff status are very close, and the ranges are roughly the same between default and payoff. With that said, the 25th percentile, medium, and 75th percentile tends to be larger for default mortgages. We believe that maybe that is because the more expensive a mortgage is, the harder for people to payoff its loan. However, this is just a guess without evidence. However, as we focus on mortgage that are around 650000 dollars, there are more payoff compare to defaults, is it because the rich has a better ability to pay? More data are needed to figure this out.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>###Default Probability vs. FICO Credit Score:
<span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% count(default_time)</code></pre>
<pre><code>## # A tibble: 2 x 2
##   default_time     n
##          &lt;dbl&gt; &lt;int&gt;
## 1            0 26452
## 2            1 15117</code></pre>
<pre class="r"><code>mortgage_norm %&gt;% summarise(meanc = mean(FICO_orig_time))</code></pre>
<pre><code>## # A tibble: 1 x 1
##   meanc
##   &lt;dbl&gt;
## 1  660.</code></pre>
<pre class="r"><code>mortgage_norm %&gt;% filter(FICO_orig_time &gt;= 450) %&gt;% mutate(Default = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;)) %&gt;% ggplot() + geom_density(aes(x = FICO_orig_time, fill = factor(Default)), position = &#39;fill&#39;,color = &#39;white&#39;,alpha = 0.85)+ theme_bw()+ scale_fill_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;)) + annotate(&#39;text&#39;,x = 550, y = 0.75,label = &#39;Total Defaults: 15117&#39;,color = &#39;white&#39;) + annotate(&#39;text&#39;,x = 750, y = 0.25,label = &#39;Total Payoffs: 26452 &#39;,color = &#39;white&#39;) + labs(x = &#39;FICO Credit Score&#39;, y = &#39;Density&#39;, title = &#39;FICO Credit Score Density Map by Default Status&#39;,subtitle = &#39;Dashed Line: Mean FICO Credit Score&#39;, fill = &#39;Mortgage Status&#39;)+geom_vline(xintercept= 659.7322, linetype=&quot;dashed&quot;, size=.7, colour = &#39;steelblue4&#39;, alpha =0.8)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 13)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>FICO scores are one kind of credit score.The name derives from the Fair Isaac Corp., which introduced the FICO score in 1989. The terms “credit score” and “FICO score” are often used interchangeably, but there are other brands of scores. FICO score is one of the most important variable that we would like to use to measure default probability. This graph shows us the relationship between the ratio of default and payoff mortgages and the FICO credit score. According to the graph, it is shown that the portion of default mortgages decreases as the FICO credit score increases.So there is a negative correlation between the FICO credit score and default probability as indicated by the correlation map. When, credit score are lower to about 400, about 75% of people will default. However, as the credit score goes up to about 850, only less than 10% of people will default. When in mean credit score, the default probability is about 50%. We believe that FICO score are strongly correlated to one’s ability to pay back, which should be concerned by banks when considering making mortgages.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>###Default Probability vs. Interest Rate:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>a &lt;- mortgage_norm %&gt;% separate(last_time_date, into = c(&#39;year&#39;,&#39;month&#39;,&#39;date&#39;),sep =&#39;-&#39;) %&gt;% count(year, default_time) %&gt;% pivot_wider(names_from = &#39;default_time&#39;, values_from = &#39;n&#39;)
b &lt;- mortgage_norm %&gt;% separate(last_time_date, into = c(&#39;year&#39;,&#39;month&#39;,&#39;date&#39;),sep =&#39;-&#39;) %&gt;% group_by(year) %&gt;% summarise(meaninterest = mean(interest_rate_mean), Total = n()) %&gt;% left_join(a, by = &#39;year&#39;) 
names(b) = c(&#39;year&#39;, &#39;Interest_Rate&#39;,&#39;Total&#39;,&#39;Payoffs&#39;,&#39;Defaults&#39;)
b &lt;- b %&gt;% mutate(default_portion = Defaults/Total)
b %&gt;% ggplot(aes(x = year, y = Interest_Rate)) + geom_line(group = 1, color = &#39;steelblue4&#39;) + geom_point(aes(size = Total, color = default_portion)) + theme_bw() + labs(x = &#39;Year&#39;,y = &#39;Interest Rate&#39;, size = &#39;Total Mortgages&#39;,color = &#39;Default Portion&#39;, title = &#39;Portion of Mortgages Ended in Default as Interest Rate Changing&#39;) + scale_color_gradient(low = &#39;skyblue1&#39;, high = &#39;dodgerblue4&#39;)+theme(plot.title = element_text(face=&quot;bold&quot;,size = 12)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Interest rate is one of the most important variables to be focused in our EDA. As we mentioned before, a lot of mortgage during the economic crisis are with adjustable interest rate. Therefore, as the interest rate goes higher, the general public’s ability to payback also goes lower. This graph shows the relationship between interest rate changes and the portion of mortgages ended in default status. According to the graph, from 2000 to 2005, interest rate decreases dramatically from about 11 to 7. The total number of mortgages are also increasing in this period, since it is cheaper for people to buy a house. The default portion also remains steady by this period. However, between 2005 and 2008, there is a significant increase from 7 to about 7.8, which is partly because of government’s intention to cool the housing market.By this time, the default portion of mortgage rises dramatically from 0.1 to 0.7, which is terrific. This is also the time with most number of mortgages. Therefore, the influence of interest rate cannot be ignored when measuring one’s ability to payback the loan. After strengthening regulation on mortgage market, we can see that the default portion starts to decrease.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>###Default Probability vs. unemployment Rate:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm %&gt;% ggplot(aes(x=uer_mean,fill= factor(default_time)))+ geom_histogram(aes(fill= factor(default_time)), color = &#39;white&#39;, position=&#39;identity&#39;,binwidth = 0.2) + theme_bw()+ scale_fill_manual(name = &#39;Mortgage Status&#39;,values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;),labels = c(&#39;Payoff&#39;,&#39;Default&#39;)) + labs(x = &#39;Unemployment Rate&#39;, y = &#39;Total Mortgages&#39;,title = &#39;Compare Default Portion and Unemployment Rate&#39;)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 13)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>This histogram here shows us the relationship between the number of default and payoff mortgages and the mean unemployment rate. According to this graph, it is apparent that the most mortgages experience a mean unemployment rate of about 4 to 6, which has a default/payoff ratio of about 0.5. However, after the unemployment rate passes 6, the total number of mortgages drops significantly, but the portion of default increases dramatically as almost all mortgages are in default. Therefore, it is evident that as the unemployment rate goes higher, people’s ability to pay the mortgage goes lower. When the unemployment rate is higher than 6%, default probability of most mortgages is almost 100%. This is reasonable, because as people lose their job, they are unable to payback their mortgages also.</p>
<p><span class="math display">\[\\[0.1in]\]</span></p>
<p>###Default Probability vs. Loan to Value Ratio:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_norm[sample(nrow(mortgage_norm ), 20000),] %&gt;% filter(LTV_orig_time &lt;= 110) %&gt;% mutate(Default = ifelse(default_time == 1, &#39;Default&#39;,&#39;Payoff&#39;)) %&gt;% ggplot()+ geom_point(aes(x = factor(Default), y = LTV_orig_time, color = factor(Default)), position = &#39;jitter&#39;,size = 0.5, alpha = 0.3) + theme_bw()+scale_color_manual(values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;)) + annotate(&#39;text&#39;, x = 1, y = 105, label = &#39;Total: 15117&#39;, color = &#39;steelblue4&#39;, fontface = &#39;bold&#39;, size = 5) + annotate(&#39;text&#39;, x = 2, y = 105, label = &#39;Total: 26452&#39;, color = &#39;steelblue2&#39;, fontface = &#39;bold&#39;, size = 5) + labs(color = &#39;Mortgage Status&#39;,x = &#39;&#39;, y = &#39;Original Loan to Value&#39;, title = &#39;Compare Original Loan to Value with Default Status&#39;)+theme(plot.title = element_text(face=&quot;bold&quot;,size = 13)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-14-1.png" width="672" />
<span class="math display">\[\\[0.2in]\]</span></p>
<p>This is a plot between default status and loan to value ratio. To make the scatter plot more visible, we randomly select 20000 mortgages in our dataset, which is about half of the total mortgages. In both default and payoff status, there is a clear segregation at the point where original Loan to Value is 80: the density of points at Original Loan to Value = 80 is the highest, which makes the line there looks thicker than all other lines. Also, the points below Original Loan to Value = 80 is clearly more than points that are above this point, indicating that in both default and payoff status, the majority’s Original Loan to Value is below 80. However, one thing worth noticing is that in ratio less than 0.7, there are much more payoff compare to defaults. In that case, we believe that people with a lower Loan to Value ratio are more likely to payback their mortgages.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<div id="default-probability-vs.-age" class="section level3">
<h3>Default Probability vs. Age:</h3>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>b &lt;- mortgage_norm %&gt;% count(age,default_time) %&gt;% pivot_wider(values_from = &#39;n&#39;, names_from = &#39;default_time&#39;)
names(b) = c(&#39;age&#39;,&#39;payoff&#39;,&#39;default&#39;)
b[is.na(b)] &lt;- 0
b &lt;- b %&gt;% mutate(total = default + payoff, default_portion = default/total ) %&gt;% filter(age &lt;= 39)
b$year &lt;- rep(1:10,each = 4)
b %&gt;% group_by(year) %&gt;% summarise(Default_Portion = mean(default_portion), SD = sd(default_portion),Total = mean(total)) %&gt;% filter(year &lt;= 13) %&gt;% ggplot(aes(x=year, y=Default_Portion)) + geom_line(color = &#39;steelblue4&#39;) + geom_point(aes(size = Total),color = &#39;steelblue4&#39;) + geom_errorbar(aes(ymin=Default_Portion-SD, ymax=Default_Portion+SD), width=.2, position=position_dodge(0.05),color = &#39;steelblue4&#39;) + theme_bw() + labs(y = &#39;Default Portion&#39;, x = &#39;Age&#39;, size = &#39;Total Mortgages&#39;, title = &#39;How Default Portion Changes with Age of Mortgages&#39;) + theme(plot.title = element_text(face=&quot;bold&quot;,size = 13))</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>We use error bar here to show how default probability floats with mortgage’s age. As the graph shows, default portion has the highest level when the age of mortgage is around 1.25 years or between 7.5 and 8.75 years, which is around 0.375. When the mortgage age is between 2.5 and 3.75 years, default portion is stable around 0.25; and then the default portion raise up to its highest level from age of 3.75 years to 7.5 years; then the portion fall back down to below 0.3 when the mortgage age approaches 10 years. The error bar goes larger as the age goes higher, we believe that is because there are less observations. However, we believe that the reason why most mortgages default in year 1 is because that most of them are originated right before the global financial crisis. They default right after the collapse of the economy. In that case, this variable may be biased.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>###Default Probability vs. House Price Index:</p>
<pre class="r"><code>mortgage_norm %&gt;% ggplot(aes(x=hpi_orig_time,fill= factor(default_time)))+ geom_histogram(aes(fill= factor(default_time)), color = &#39;white&#39;, position=&#39;identity&#39;,binwidth = 5) + theme_bw()+ scale_fill_manual(name = &#39;Mortgage Status&#39;,values = c(&#39;steelblue4&#39;,&#39;steelblue2&#39;),labels = c(&#39;Payoff&#39;,&#39;Default&#39;)) + labs(x = &#39;House Price Index&#39;, y = &#39;Total Mortgages&#39;,title = &#39;Compare Default Portion and House Price Index&#39;)+ theme(plot.title = element_text(face=&quot;bold&quot;,size = 13)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-16-1.png" width="672" />
<span class="math display">\[\\[0.2in]\]</span></p>
<p>We choose the initial house price index to compare with default status, because we assume no refinance of mortgages in our dataset. As the graph shows, when the House Price Index is less than 200, payoff status outnumbered default status in all situations. But when House Price Index is more than 200, portion of default increased drastically and outnumbered payoff portion; and finally, the default rate becomes 100% as the House Price Index increases to more than 200. This is obvious that as the price of the house goes higher, people are less likely to pay back their loans.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>a &lt;- mortgage_norm %&gt;% separate(last_time_date, into = c(&#39;year&#39;,&#39;month&#39;,&#39;date&#39;),sep =&#39;-&#39;) %&gt;% count(year, default_time) %&gt;% pivot_wider(names_from = &#39;default_time&#39;, values_from = &#39;n&#39;)
b &lt;- mortgage_norm %&gt;% separate(last_time_date, into = c(&#39;year&#39;,&#39;month&#39;,&#39;date&#39;),sep =&#39;-&#39;) %&gt;% group_by(year) %&gt;% summarise(meanSP = mean(SP), Total = n()) %&gt;% left_join(a, by = &#39;year&#39;) 
names(b) = c(&#39;year&#39;, &#39;SP_Index&#39;,&#39;Total&#39;,&#39;Payoffs&#39;,&#39;Defaults&#39;)
b &lt;- b %&gt;% mutate(default_portion = Defaults/Total)
b %&gt;% ggplot(aes(x = year, y = SP_Index)) + geom_line(group = 1, color = &#39;steelblue4&#39;) + geom_point(aes(size = Total, color = default_portion)) + theme_bw() + labs(x = &#39;Year&#39;,y = &#39;S&amp;P Stock Market Index&#39;, size = &#39;Total Mortgages&#39;,color = &#39;Default Portion&#39;, title = &#39;Portion of Mortgages Ended in Default as Stock Market Index Changing&#39;) + scale_color_gradient(low = &#39;skyblue1&#39;, high = &#39;dodgerblue4&#39;)+theme(plot.title = element_text(face=&quot;bold&quot;,size = 11)) </code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>As the graph shows, before the year of 2007, though the Stock Market Index changed drastically – a sharp decrease from 1450 in year 2000 to below 1000 in year 2003, and then a sharp increase to 1400 in year 2007 – the default portion during these years didn’t change a lot, which is always around 10%. However, in year 2008, as the global economic crisis happened, the default portion has increased to over 60% until year 2013. This is reasonable because by 2003 to 2007, a huge amount of financial derivative of mortgage released. In that case, financial market started to link mortgage default probability. As the stock index dropped from 1400 to around 1200, mortgage default portion rises in unprecedented speed. Therefore, financial market status should be considered when marking loan to house buyer.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="default-probability-vs.state" class="section level3">
<h3>Default Probability vs.State:</h3>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>mortgage_last&lt;-mortgage %&gt;% group_by(id) %&gt;%  summarise_all(last) 
epsg_us_equal_area &lt;- 2163
us_states &lt;- st_read(here::here(&quot;dataset/cb_2019_us_state_20m/cb_2019_us_state_20m.shp&quot;))%&gt;% 
  st_transform(epsg_us_equal_area)</code></pre>
<pre><code>## Reading layer `cb_2019_us_state_20m&#39; from data source 
##   `/Users/alex/Desktop/fa2021-final-project-digfora/dataset/cb_2019_us_state_20m/cb_2019_us_state_20m.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 52 features and 9 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -179.1743 ymin: 17.91377 xmax: 179.7739 ymax: 71.35256
## Geodetic CRS:  NAD83</code></pre>
<pre class="r"><code>not_contiguous &lt;-
  c(&quot;Guam&quot;, &quot;Commonwealth of the Northern Mariana Islands&quot;,
    &quot;American Samoa&quot;, &quot;Puerto Rico&quot;, &quot;Alaska&quot;, &quot;Hawaii&quot;,
    &quot;United States Virgin Islands&quot;)

us_cont &lt;- us_states %&gt;%
  filter(!NAME %in% not_contiguous) %&gt;% filter(NAME != &quot;District of Columbia&quot;) %&gt;%
  transmute(STUSPS,STATEFP,NAME, geometry)
p &lt;- mortgage %&gt;% group_by(state_orig_time) %&gt;% summarize(count = n(),def = sum(status_time[status_time == 1])) %&gt;% mutate(proportion = formattable::percent(def / count))
us_cont %&gt;% inner_join(p, by = c(&quot;STUSPS&quot; = &quot;state_orig_time&quot;)) %&gt;% tm_shape() + tm_polygons(col = &quot;proportion&quot;,palette = &quot;Blues&quot;) + tm_text(&quot;STUSPS&quot;, size = 1/2) + tm_layout(title= &#39;percentage of number of default&#39;)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>This map shows the portion of number of default cases in each state in US. We can see from the map that west coast and Southeastern coast, including CA, NV and FL, has the highest proportion of default cases, which is around 2.5% to 4,5%. Then around Northeastern, including MN, MI, ME and OH, has the second highest proportion of default cases, which is around 2% to 3.5%. Northwestern, middle south and eastern coast has the lowest proportion of default cases, which is around 0.5% to 2%. However, we decided not to included state as an variable in our dataset since there will be 50 more dummy variables to be added.
<span class="math display">\[\\[0.1in]\]</span></p>
<p>After our EDA, we would like to have a feature selection to determine which variables to be kept in our dataset. We would like to use the leaps packages to specific variables to be included in our model. We would like to use the exhaustive method and have a maximum of 12 variables:
<span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>Modeldata &lt;- mortgage_norm %&gt;% select(default_time,orig_time, REtype_SF_orig_time,investor_orig_time, balance_orig_time,FICO_orig_time, LTV_orig_time, interest_rate_mean, hpi_orig_time,uer_mean,gdp_mean,age,SP)
leaps_fit &lt;- leaps::regsubsets(default_time ~ ., data = Modeldata, method = &#39;exhaustive&#39;, nvmax = 12)</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As followed, we would like to visualize the result of the feature selection:
<span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>a &lt;- as.tibble(summary(leaps_fit)$cp)
b &lt;- as.tibble(summary(leaps_fit)$bic)
c &lt;- as.tibble(summary(leaps_fit)$adjr2)
a$Number &lt;- seq(1,12,1)
b$Number &lt;- seq(1,12,1)
c$Number &lt;- seq(1,12,1)
Performance &lt;- a %&gt;% left_join(b, by = &#39;Number&#39;) %&gt;% left_join(c, by = &#39;Number&#39;)
names(Performance) = c(&#39;CP&#39;,&#39;Number&#39;,&#39;BIC&#39;,&#39;AdjustedR2&#39;)
ggplot(Performance, aes(y = BIC))  + geom_point(aes(x = factor(Number),size = AdjustedR2),color = &#39;steelblue4&#39;)+ geom_line(aes(x = Number),color = &#39;steelblue4&#39;)+theme_bw()+labs(x = &#39;Number of Variables&#39;, y = &#39;BIC&#39;,title = &#39;Compare BIC, Adjusted R Sqaure and Number of Variables&#39;)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As we can see from the chart here that as the number of variables increases, BIC decreases and Adjusted R square increases, which means that our performance of our model is getting better. With more than 9 variables, our model tends to have an adjusted R square of around 25%, which means that 25% of the variation in default or not can be explained by our explanatory variables. The model with 10 variables has lowest BIC(-12642.253) and relatively high adjusted R square(26.41291%) , therefore, we would like to choose the model with 10 variables. We would like to exclude original balance and original time in our model indicated by our feature selection result.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Before making the model, we would like to separate our dataset into train and test dataset, we will choose choose a randomized 70% household for training data, and the rest for test data.(Code from <a href="https://www.statology.org/confusion-matrix-in-r/" class="uri">https://www.statology.org/confusion-matrix-in-r/</a>)</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>data &lt;- mortgage_norm
set.seed(1)
sample &lt;- sample(c(TRUE, FALSE), nrow(data), replace=TRUE, prob=c(0.7,0.3))
train &lt;- data[sample, ]
test &lt;- data[!sample, ]</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="logistic" class="section level3">
<h3>Logistic:</h3>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>Logistic_Model &lt;- glm(default_time ~ age  + REtype_SF_orig_time+
interest_rate_mean+gdp_mean+hpi_orig_time+uer_mean+investor_orig_time+FICO_orig_time+LTV_orig_time+age+SP, data = train, family = binomial) 
Logistic_Model %&gt;% broom::tidy() %&gt;% knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">std.error</th>
<th align="right">statistic</th>
<th align="right">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-2.6365954</td>
<td align="right">0.3974081</td>
<td align="right">-6.634478</td>
<td align="right">0.0000000</td>
</tr>
<tr class="even">
<td align="left">age</td>
<td align="right">-0.0320742</td>
<td align="right">0.0039051</td>
<td align="right">-8.213473</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">REtype_SF_orig_time</td>
<td align="right">-0.0732574</td>
<td align="right">0.0300077</td>
<td align="right">-2.441289</td>
<td align="right">0.0146349</td>
</tr>
<tr class="even">
<td align="left">interest_rate_mean</td>
<td align="right">0.0847245</td>
<td align="right">0.0107629</td>
<td align="right">7.871919</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">gdp_mean</td>
<td align="right">-0.9296961</td>
<td align="right">0.0197045</td>
<td align="right">-47.181932</td>
<td align="right">0.0000000</td>
</tr>
<tr class="even">
<td align="left">hpi_orig_time</td>
<td align="right">0.0043628</td>
<td align="right">0.0006793</td>
<td align="right">6.422165</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">uer_mean</td>
<td align="right">0.0498199</td>
<td align="right">0.0207821</td>
<td align="right">2.397251</td>
<td align="right">0.0165186</td>
</tr>
<tr class="even">
<td align="left">investor_orig_time</td>
<td align="right">0.3718477</td>
<td align="right">0.0455207</td>
<td align="right">8.168753</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">FICO_orig_time</td>
<td align="right">-0.0062101</td>
<td align="right">0.0002497</td>
<td align="right">-24.872589</td>
<td align="right">0.0000000</td>
</tr>
<tr class="even">
<td align="left">LTV_orig_time</td>
<td align="right">0.0259683</td>
<td align="right">0.0015637</td>
<td align="right">16.607045</td>
<td align="right">0.0000000</td>
</tr>
<tr class="odd">
<td align="left">SP</td>
<td align="right">0.0031322</td>
<td align="right">0.0001995</td>
<td align="right">15.701400</td>
<td align="right">0.0000000</td>
</tr>
</tbody>
</table>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As followed, we would like to use the Caret package to plot the importance of each variables in our model to determine their weights to predict default rate.
<span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>Imp &lt;- varImp(Logistic_Model, scale = FALSE) %&gt;% arrange(desc(Overall))
Imp %&gt;% mutate(var = rownames(Imp)) %&gt;% mutate(Variables = fct_reorder(var, Overall)) %&gt;% ggplot(aes(y = Overall, x = Variables)) + geom_col(fill = &#39;steelblue4&#39;) + coord_flip()+ theme_bw()+labs(x = &#39; Variables&#39;, y = &#39;Importance&#39;,title = &#39;Variable Importance in Logistic Model&#39;)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>As we can see from the chart here, mean GDP growth and S&amp;P stock index is the most outside economic variables to determine default rate in mortgage market. This is reasonable-as the economy of the country rises, more people have a good job and can afford to payoff the mortgage. Therefore, GDP growth is the dominant determinant when considering to give a mortgage or not. Meanwhile, FICO score and original loan to value are the second and third most important factor to be considered when making mortgages. This tells us that personal characteristics also plays an important roll when considering to give a mortgage or not. Therefore, when trying to measure the probability of default, banks should consider both outside economic data and inside personal information. Only by a comprehensive consideration can we better measure the credit risk inside the mortgage market. As followed, we would like to measure the overall performance of our model by adpating the model to our test data.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Confusion Matrix For Logistic Model on Test Data:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>predicted &lt;- predict(Logistic_Model, test, type=&quot;response&quot;)
optimal &lt;- optimalCutoff(test$default_time, predicted)
b &lt;- confusionMatrix(test$default_time, predicted)
TClass &lt;- factor(c(0, 0, 1, 1))
PClass &lt;- factor(c(0, 1, 0, 1))
Y      &lt;- c(6615,1270, 1843 , 2746)
df &lt;- data.frame(TClass, PClass, Y)
ggplot(data =  df, mapping = aes(x = TClass, y = PClass)) +
  geom_tile(aes(fill = Y), colour = &quot;white&quot;) +
  geom_text(aes(label = sprintf(&quot;%1.0f&quot;, Y)), vjust = 1, color = &#39;white&#39;) +
  scale_fill_gradient(low = &quot;skyblue&quot;, high = &quot;steelblue3&quot;) +
  theme_bw() + theme(legend.position = &quot;none&quot;)+ labs(title = &#39;Confusion Matrix For Logistic Model&#39;)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>Shown by the confusion matrix, the model has a overall accuracy of about 75% on test data, with true positive of 2746 and true negative of 6615 out of about 12000 mortgages, which can be considered effective. As followed, we would like to measure it by ROC curve by ploting an ROC curve on test data.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>LinearData &lt;- test %&gt;% add_predictions(Logistic_Model, type = &#39;response&#39;)
roc(LinearData$default_time,LinearData$pred,plot = TRUE)</code></pre>
<pre><code>## Setting levels: control = 0, case = 1</code></pre>
<pre><code>## Setting direction: controls &lt; cases</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<pre><code>## 
## Call:
## roc.default(response = LinearData$default_time, predictor = LinearData$pred,     plot = TRUE)
## 
## Data: LinearData$pred in 7885 controls (LinearData$default_time 0) &lt; 4589 cases (LinearData$default_time 1).
## Area under the curve: 0.8177</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>We would like to use the pROC package. An ROC curve is one of the best way to measure the performance of model with output between 0 and 1, which corresponds to our default probability. In a ROC curve, an AUC of 0.5 is considered just guessing. As we can see here, our model has an AUC of 0.8163, which can be considered excellent. This is the end for our logistic model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
</div>
</div>
<div id="addtional-models" class="section level1">
<h1>Addtional Models</h1>
<p>Before making our model, we read a few papers online and discovered that a lot of banks use models other logistic regression to measure the risk of default including K-Nearest Neighbor, Lasso Regression, Ada boosting, Neural Network, and RandomForest. Most papers considered RandomForest and Lasso as a better model to measure default rate compare to logistic regression. Therefore we would like to fit the variables given by leaps package in these models to see if they can do a better job.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<div id="randomforest" class="section level2">
<h2>RandomForest:</h2>
<p><span class="math display">\[\\[0.1in]\]</span></p>
<p>RandomForest model derives from the idea of decision tree model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Decision tree learning is one of the predictive modelling method used in data science and machine learning. It uses a decision tree (as a predictive model) to go from observations about an item (represented in the branches) to conclusions about the item’s target value (represented in the leaves). Classification tree models where the target variable can take a discrete set of values. In these tree structures, leaves represent class labels and branches represent conjunctions of features that lead to those class labels. Therefore, as the more data provided, more branches are created. In that case, the model is getting better in predicting target velue.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>However, one important issue with the decision tree model is overfitting. As the number of leaves increasing, the problem of overfitting rises as well, because we took the noise in the dataset into account also. Therefore, the idea of ranfomForest is created to avoid this problem. RandomForest bootstraps the training dataset to grow a decision tree in each subdataset with a number of randomly selected variables as its branches. Therefore, multiple instead of one decision tree are created to make the model. Each of these trees will give a final result on default or not. Then each result count as a vote on default or not, and the final probability of default is given by the portion of votes on defaults by all these trees. We start by training the model with train dataset.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>trainrf &lt;- train %&gt;% mutate(Default = as.factor(default_time))
testrf &lt;- test %&gt;% mutate(Default = as.factor(default_time))
rf &lt;- randomForest(Default ~ age + REtype_SF_orig_time+
interest_rate_mean+gdp_mean+hpi_orig_time+uer_mean+investor_orig_time+FICO_orig_time+LTV_orig_time+age+SP, family = binomial, data = trainrf,importance=TRUE)</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As followed, I would like to examine the performance by plotting it into ROC curve on test dataset</p>
<p><span class="math display">\[\\[0.1in]\]</span></p>
<pre class="r"><code>predicted &lt;- as.tibble(predict(rf, testrf, type=&quot;vote&quot;))[1]
colnames(predicted)[1] &lt;- &#39;predict&#39;
testrf &lt;- testrf %&gt;% mutate(pred = predicted$predict)
roc(testrf$default_time,testrf$pred,plot = TRUE)</code></pre>
<pre><code>## Setting levels: control = 0, case = 1</code></pre>
<pre><code>## Setting direction: controls &gt; cases</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<pre><code>## 
## Call:
## roc.default(response = testrf$default_time, predictor = testrf$pred,     plot = TRUE)
## 
## Data: testrf$pred in 7885 controls (testrf$default_time 0) &gt; 4589 cases (testrf$default_time 1).
## Area under the curve: 0.8432</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As we can see from the ROC curve, the randomForest model has a much higher AUC, which is about 0.85 compare to that of the logistic model(0.81). We believe that is because a logistic model can avoid overfitting. By growing a number of trees and give the probability of the mean value of independent votes, the noise in sub-dataset will not effect the overall predict result because of the central limit theorem. However, one disadvantage of random forest model is that it gives little detail explanation on the influence of each variables. What is more, we also do not know we the model comes to this result since the whole machine learning is invisible to us.Here, We use the Caret package again to have a glance of the importance of different variables in the model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>importance(rf,type = 2)</code></pre>
<pre><code>##                     MeanDecreaseGini
## age                         653.8986
## REtype_SF_orig_time         263.7848
## interest_rate_mean         1952.1886
## gdp_mean                   2658.9678
## hpi_orig_time              1461.1258
## uer_mean                   1336.5263
## investor_orig_time          164.3199
## FICO_orig_time             2148.8718
## LTV_orig_time              1173.4905
## SP                         1288.8551</code></pre>
<pre class="r"><code>varImpPlot(rf)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Apparently, FICO score, GDP growth, and LTV is still the predominant factor to consider one’s default ability in this model. However, Compare to our logistic model, Unemployment Rate has is much more important in the Random Forest model. We still do not know the reason. However, we are sure that the ability of individual variable to predict target value is different in Logistic and Random Forest Model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
</div>
<div id="lasso-regression" class="section level2">
<h2>Lasso Regression:</h2>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<div id="this-model-is-inspired-by-stanfords-introduction-to-glmnet-package-written-by-trevor-hastie-junyang-qian-and-kenneth-tay." class="section level3">
<h3>This model is inspired by Stanford’s <a href="https://glmnet.stanford.edu/articles/glmnet.html">introduction to glmnet package</a> written by Trevor Hastie, Junyang Qian, and Kenneth Tay.</h3>
<p>lasso (least absolute shrinkage and selection operator; also Lasso or LASSO) is a regression analysis method that performs both variable selection and regularization in order to enhance the prediction accuracy and interpret-ability of the resulting statistical model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>To start the Lasso Regession (with machine learning), we started by using similar partition idea in logistic regression:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>data_lasso &lt;- mortgage_norm
set.seed(1)
sample &lt;- sample(c(TRUE, FALSE), nrow(data), replace=TRUE, prob=c(0.7,0.3))
train.data &lt;- data_lasso[sample, ]
test.data &lt;- data_lasso[!sample, ]</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>By applying R function glmnet() [glmnet package] for computing penalized logistic regression.
The usage of variables are described as follow:
<em>x: matrix of predictor variables
</em>y: the response or outcome variable, which is a binary variable.
*alpha: the elasticnet mixing parameter. Allowed values include:
<strong>“1”: for lasso regression
</strong>“0”: for ridge regression
**a value between 0 and 1 for elastic net regression.
*lamba: a numeric value defining the amount of shrinkage.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>x &lt;- model.matrix(default_time ~ age  + REtype_SF_orig_time+
interest_rate_mean+gdp_mean+hpi_orig_time+uer_mean+investor_orig_time+FICO_orig_time+LTV_orig_time+age+SP, data = train.data)[,-1]

y &lt;- ifelse(train.data$default_time == 1, 1, 0)
fit &lt;- glmnet(x, y, family = &quot;binomial&quot;)</code></pre>
<pre class="r"><code>x.test &lt;- model.matrix(default_time ~ age  + REtype_SF_orig_time+
interest_rate_mean+gdp_mean+hpi_orig_time+uer_mean+investor_orig_time+FICO_orig_time+LTV_orig_time+age+SP,  test.data)[,-1]
set.seed(123)
cvfit &lt;- cv.glmnet(x, y, family = &quot;binomial&quot;, type.measure = &quot;class&quot;)
plot(cvfit)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>We started by working with similar methods in logistic regression, and we use glmnet package to plot the cvfit which enables us to see the optimal values of lambda. This lambda value will give the most accurate model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>We received two different lambdas. lambda.min gives a model with the smallest number of predictors that also gives a good accuracy, while lambda.1se gives the simplest model but also lies within one standard error of the optimal value of lambda. This value is called lambda.1se. We can see the coefficient in the following code</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>cvfit$lambda.min</code></pre>
<pre><code>## [1] 0.0008913206</code></pre>
<pre class="r"><code>cvfit$lambda.1se</code></pre>
<pre><code>## [1] 0.006901172</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code>coef(cvfit, cvfit$lambda.1se)</code></pre>
<pre><code>## 11 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
##                               s1
## (Intercept)         -1.860096870
## age                 -0.014434603
## REtype_SF_orig_time  .          
## interest_rate_mean   0.079379688
## gdp_mean            -0.875595002
## hpi_orig_time        0.005392535
## uer_mean             .          
## investor_orig_time   0.226750768
## FICO_orig_time      -0.005145818
## LTV_orig_time        0.020511852
## SP                   0.002277904</code></pre>
<pre class="r"><code>coef(cvfit, cvfit$lambda.min)</code></pre>
<pre><code>## 11 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
##                               s1
## (Intercept)         -2.430491815
## age                 -0.029035220
## REtype_SF_orig_time -0.060951181
## interest_rate_mean   0.083178440
## gdp_mean            -0.926336403
## hpi_orig_time        0.004557043
## uer_mean             0.034897747
## investor_orig_time   0.353332819
## FICO_orig_time      -0.006062420
## LTV_orig_time        0.025218146
## SP                   0.002970744</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>As we can see from above, in lambda.1se, variables uer_mean and REtype_SF_orig_time are penalized to 0, which means that these two variables are kicked out by lasso’s nature of penalization. In this model, we will use lambda.1se to fit the model.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Then, we plot the ROC curve:</p>
<pre class="r"><code>cfit &lt;- cv.glmnet(x, y, family = &quot;binomial&quot;, type.measure = &quot;auc&quot;, 
                  keep = TRUE)
rocs &lt;- roc.glmnet(cfit$fit.preval, newy = y)

best &lt;- cvfit$index[&quot;min&quot;,]
plot(rocs[[best]], type = &quot;l&quot;)
invisible(sapply(rocs, lines, col=&quot;grey&quot;))
lines(rocs[[best]], lwd = 2,col = &quot;blue&quot;)</code></pre>
<p><img src="/analysis_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Finally, we fit the model by using lambda 1se and check the accuracy of the model:</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<pre class="r"><code># Final model with lambda.1se
lasso.model &lt;- glmnet(x, y, alpha = 1, family = &quot;binomial&quot;,
                      lambda = cvfit$lambda.1se)
# Make prediction on test data
x.test &lt;- model.matrix(default_time ~ age  + REtype_SF_orig_time+
interest_rate_mean+gdp_mean+hpi_orig_time+uer_mean+investor_orig_time+FICO_orig_time+LTV_orig_time+age+SP,   test.data)[,-1]
probabilities &lt;- lasso.model %&gt;% predict(newx = x.test)
predicted.classes &lt;- ifelse(probabilities &gt; 0.5, 1, 0)
# Model accuracy rate
observed.classes &lt;- test.data$default_time
mean(predicted.classes == observed.classes)</code></pre>
<pre><code>## [1] 0.7138849</code></pre>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Overall, the Lasso method kicked out two variables because of penalization, and overall accuracy was 0.71, which is fairly a strong model.</p>
</div>
</div>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Overall, after our analysis and modeling, we believe that mortgage issuer should adopt different kinds of information to different models to measure the credit risk of specific mortgages.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>Three modeling methods all agree that GDP, FICO Score, and Loan to Value Ratio will play important roles in people’s behaviors of whether paying or not paying back their mortgages. As issuers and financial analysts, the aggregate change of these variables should be closely examine. Moreover, different models tend to select different variables playing a minor role in the story — logistic regression and lasso regression manifest that whether an individual is in single family or not does not have significant correlation the default probability for lenders, and unemployment rate does not as well. This counters our intuition, but it is understandable – while unemployed and single-family people are not able to pay back, their willingness to apply mortgages are low. Random Forest gives us the result that whether one is with investor is minor in the correlation as well. SO, it is important to combine different models.</p>
<p><span class="math display">\[\\[0.2in]\]</span></p>
<p>By applying different models, different variables’ importance are re-evaluated, and we also realized that forecasting modeling is somehow subjective, which make me believe that using different models to forecast are the right thing to do.</p>
</div>
